#!/bin/bash
#
# File: check-pdf-errors
# Version: 0.97 (Directory Aware)
#
# Checks whether the PDF files in the current directory have issues in matching the CEURART style.
# (C) 2024-2025 by Manfred Jeusfeld. This script is made available under the
# Creative Commons Attribution-ShareAlike CC-BY-SA 4.0 license.
#
# The BASH script is part of the scripts used for CEUR-WS.org. No warrantee whatsoever. No support. 
#
# Requires the installation of certain packages, in particular pdf2txt, pdffonts, and perl. The tool pdf2txt is part of the 
# package python-pdfminer.  The pdffonts command is paper of the package poppler-utils.  
# Install on Debian-based systems with
#    sudo apt install python3-pdfminer
#    sudo apt-get install poppler-utils
#    sudo apt-get install perl
#
# On Mac OS (no guaratee that it works)
#    python3-pdfminer (pdfminer.six via pip3)
#    poppler-utils (via Homebrew)
#
# Note that this script is updated on a regular basis, in particular to cover changes with
# the CEURART layout for papers. See ceur-ws.org/Vol-XXX/ for the CEURART specification.
#
# Call this script in the directory that contains the PDF files that you want to check.
#
# Manfred 2024-08-17 (2025-12-17)
#

# --- TARGET DIRECTORY SELECTION ---
TARGET_DIR="${1:-.}"
if [[ ! -d "$TARGET_DIR" ]]; then
    echo "Error: Directory '$TARGET_DIR' does not exist."
    exit 1
fi

# Define a function specifying which PDF files do NOT need to be tested
isExcludedFile() {
    local filename="$1"
    
    case "$filename" in
        *"reface"*".pdf" | *"rganization.pdf" | *"ponsors.pdf" | *"bstract"*".pdf" | *"ommittee"*".pdf" | *"matter"*".pdf" | *"ditorial.pdf")
            return 0  # "True" in bash exit codes
            ;;
        *)
            return 1  # "False"
            ;;
    esac
}

if ! ls "$TARGET_DIR"/*.pdf &> /dev/null; then
    echo "No file with filetype *.pdf in directory: $TARGET_DIR"
    exit 1
fi

echo "check-pdf-errors V0.97 (Directory Aware) CC-BY-SA 4.0"
echo "Targeting: $TARGET_DIR"
echo ""
echo "(*) Readable/Selectable text inside PDF files"
ABSTRACTWORD="found"
for f in "$TARGET_DIR"/*.pdf
do
  fname=$(basename "$f")
  echo -en "\rChecking $fname                "
  # PDF files should have the computer-readable string "Abstract" or "Copyright" on the first two pages (normally page 1)
  pdf2txt -m 2 "$f" | grep -E 'Abstract|Copyright' 2>&1 > /dev/null
  if [[ $? != 0 ]];
  then
     if [[ "$fname" != *"reface"*".pdf" && "$fname" != *"rganization.pdf" && "$fname" != *"ponsors.pdf" && "$fname" != *"ommittee"*".pdf" && "$fname" != *"matter"*".pdf" ]]
     then
        ABSTRACTWORD="notfound"
        echo -e "\rPDF file $fname seems to have no readable text included but only binary data"
     fi
  fi
done
if [[ "$ABSTRACTWORD" == "notfound" ]] ; then
  echo -e "\r ===> Make sure that paper PDFs have readable/selectable text in them; use a proper PDF printer driver on Windows such as PDFCreator or use LibreOffice PDF export"
  echo " "
else
  echo -e "\rok                                                                            "
  echo " "
fi


echo ""
echo "(*) CEUR-WS standard copyright phrase"
CREATIVECOMMONS="found"
for f in "$TARGET_DIR"/*.pdf
do
  fname=$(basename "$f")
  echo -en "\rChecking $fname                   "

  if isExcludedFile "$fname" ; then
     continue
  fi

  # PDF files should have the string "Creative Commons License" on the first two pages; copyright year may not be 2022 or 2023 
  # left unmodified by the author when using the CEURART template
#  pdf2txt -m 2 "$f" | grep -E 'Creative.*Commons.*License|Commons.*License.*Attribution' 2>&1 > /dev/null
  pdf2txt -m 2 "$f" | grep -E 'Creative.*Commons.*License|Commons.*License.*Attribution' | grep -Ev '2022|2023' 2>&1 > /dev/null
  if [[ $? != 0 ]];
  then
     CREATIVECOMMONS="notfound"
     echo -e "\rPDF file $fname seems to lack the proper copyright clause or copyright year on page 1"

  fi
done
if [[ $CREATIVECOMMONS == "notfound" ]] ; then
  echo -e "\r ===> Make sure that paper PDFs have the correct copyright clause, see https://ceur-ws.org/HOWTOSUBMIT.html#CCBY-FOOTNOTE"
  echo " ===> Make sure that paper PDFs have the correct *year* in the copyright clause!"
  echo " "
else
  echo -e "\rok                                                                         "
  echo " "
fi


echo ""
echo "(*) Declaration on Generative AI"
GENAIDECL="ok"
for f in "$TARGET_DIR"/*.pdf
do
  fname=$(basename "$f")
  echo -en "\rChecking $fname              "

  if isExcludedFile "$fname" ; then
     continue
  fi

  temp_file=$(mktemp /tmp/pdftext.XXXXXX.txt)
#  pdftotext "$f" "$temp_file"
  pdf2txt "$f" > "$temp_file"
  # Test 1: PDF files should have a section "Declaration on Generative AI"
  # cat "$temp_file" | grep -E 'Declaration.* [G|g]enerative AI|[G|g]enerative AI *[D|d]eclaration|Declaration .. GenAI' 2>&1 > /dev/null
  cat "$temp_file" | grep -i -F 'declaration' | grep -E '[Gg]enerative\s+AI|[Gg]enAI' 2>&1 > /dev/null
  if [[ $? != 0 ]];
  then
     GENAIDECL="notok"
     echo -e "\rPDF file $fname seems to lack a section Declaration on Generative AI"
     /bin/rm "$temp_file"
     continue;
  fi
  # Test 2: The phrase "The author ... not employed any Generative AI tools." is fine; not more checks needed
  cat "$temp_file" | grep -E 'The author.*not employed any Generative AI tools\.' 2>&1 > /dev/null
  if [[ $? == 0 ]];
  then
    /bin/rm "$temp_file"
    continue;  # This file is ok
  fi
  # Test 3: Test on fake AI tool names from our template
  cat "$temp_file" | grep -E 'X-GPT-.|Gramby|X-AI-IMG' 2>&1 > /dev/null
  if [[ $? == 0 ]];
  then
     GENAIDECL="notok"
     echo -e "\rPDF file $fname seems to mention non existing tools X-GPT-.|Gramby|X-AI-IMG in its Declaration on Generative AI"
     /bin/rm "$temp_file"
     continue;
  fi

  /bin/rm "$temp_file"
done
if [[ $GENAIDECL == "notok" ]] ; then
  echo -e "\r ===> Make sure that paper PDFs have a Generative AI Declaration conforming https://ceur-ws.org/GenAI/Policy.html"
  echo " "
else
  echo -e "\rok                                                                    "
  echo " "
fi


echo ""
echo "(*) Use of CEUR-WS.org logo or link or string CEUR Workshop Proceedings before publication"
CEURWSLINKFOUND="notfound"
for f in "$TARGET_DIR"/*.pdf
do
  fname=$(basename "$f")
  echo -en "\rChecking $fname            "
  
  # Note: watermark-log check remains relative to current execution context or script dir
  if [ -f watermark-log.txt ]; then
    if grep -q "$fname" watermark-log.txt; then
      continue;
    fi
  fi

  if isExcludedFile "$fname" ; then
     continue
  fi

  # PDF files should not have the string "(CEUR-WS.org)" on the first two pages
  pdf2txt -m 2 "$f" | grep -E '(CEUR-WS.org)|CEUR Workshop Proceedings' 2>&1 > /dev/null
  if [[ $? == 0 ]];
  then
     CEURWSLINKFOUND="found"
     echo -e "\rPDF file $fname uses 'CEUR-WS.org' or 'CEUR Workshop Proceedings' before publication"
  fi
done
if [[ $CEURWSLINKFOUND == "found" ]] ; then
  echo -e "\r ===> Use the latest CEURART template from https://ceur-ws.org/Vol-XXX/, which does not have a footnote with the CEUR-WS logo; Do not use the string 'CEUR Workshop Proceedings' in the header or footer of papers"
  echo " "
else
  echo -e "\rok                                                                      "
  echo " "
fi


echo ""
echo "(*) Libertinus font in paper PDFs"
NONLIBERTINUSFOUND="no"

if [[ ! -f $HOME/bin/check-libbyhead.py ]]; then
   echo " --> Extra test routine check-libbyhead.py missing. Result of this test is therefore incomplete."
fi

for f in "$TARGET_DIR"/*.pdf
do
  fname=$(basename "$f")
  echo -en "\rChecking $fname                         "

  if isExcludedFile "$fname" ; then
     continue
  fi

  # 2025-12-15: We inspect the actual use of Libertinus fonts on page 1 for the headings
  if [[ -f $HOME/bin/check-libbyhead.py ]]; then
    if ! python3 $HOME/bin/check-libbyhead.py "$f" ; then  
            NONLIBERTINUSFOUND="found"
            echo -e "\rPDF file $fname does not use Libertinus font family for headings"
    fi
  fi
  # Files created with Windows Word/LibreOfffice apparently use CIDFont+F instead Libertinus as font name (?)
  strings "$f" | grep FontName | grep -q -E 'Libertinus|CIDFont.F5'
  if [[ $? != 0 ]];
  then
       pdffonts 2> /dev/null "$f" | grep -q -E 'Libertinus|CIDFont.F5'
       if [[ $? != 0 ]] ; then
          NONLIBERTINUSFOUND="found"
          echo -e "\rPDF file $fname does not use Libertinus font family"
       fi
  fi
done
if [[ $NONLIBERTINUSFOUND == "found" ]] ; then
  echo -e "\r ===> Make sure that paper PDFs use the Libertinus font family; instructions to install Libertinus fonts are included in https://ceur-ws.org/Vol-XXX/CEUR-Template-1col.odt; paper PDFs should all use Libertinus fonts, prefaces that have no paper character do not necessarily need to use Libertinus; do not use Word/MS365 but rather use LibreOffice and its PDF exporter"
  echo " "
else
  echo -e "\rok                                                                                                   "
  echo " "
fi

echo ""
echo "(*) Duplicate PDF files"
DUPPDFSFILES=`find "$TARGET_DIR" -name '*.pdf' ! -empty -type f -exec md5sum {} + | sort | uniq -w32 -dD`
if [ "$DUPPDFSFILES" != "" ]
then echo -e "\r ";
     echo " ==========> ERROR (P2) with duplicate PDF files!!!!"
     echo "$DUPPDFSFILES"
  echo " "
else
  echo -e "\rok                                                                                                     "
  echo " "
fi

echo ""
echo "(*) Leftover elements from CEURART in the footer of page 1"
NOLEFTOVER="yes"
for f in "$TARGET_DIR"/*.pdf
do
  fname=$(basename "$f")
  echo -en "\rChecking $fname                 "
  # PDF files should not have leftover elements from the CEURART template in the footer
  pdf2txt -m 2 "$f" | grep -E '0000-0000-0000-0000|Woodstock.*22|0000-0002-0877-7063.*0000-0001-7116-9338.*0000-0002-9421-8566'  2>&1 > /dev/null
  if [[ $? == 0 ]];
  then
     NOLEFTOVER="no"
     echo -e "\rPDF file $fname seems to have some leftover elements from the footer of the CEURART template on page 1 such as ORCIDs or the event name"
  fi
done
if [[ $NOLEFTOVER == "no" ]] ; then
  echo -e "\r ===> Make sure that paper PDFs have correct data in the footnote section of page 1"
  echo " "
else
  echo -e "\rok                                                                    "
  echo " "
fi


if [[ ! -x $HOME/bin/check-columns ]]; then
    echo " "
    echo "(*) Check manually if all paper PDFs are in CEURART one-column style"
    echo " "
else
  # A better test on one-column 
  echo ""
  echo "(*) Check on one-column style"
  TWOCOLUMNFOUND="no"
  for f in "$TARGET_DIR"/*.pdf
  do
    fname=$(basename "$f")
    if isExcludedFile "$fname" ; then
       continue
    fi

    echo -en "\rChecking $fname           "
    $HOME/bin/check-columns "$f"
    # previous command returns error code 1 if a file is presumably in two-column mode
    if [ $? -ne 0 ]; then
      TWOCOLUMNFOUND="yes"
      echo -e "\rPDF file $fname seems to be in two column format"
    fi
  done

  if [[ "$TWOCOLUMNFOUND" == "yes" ]] ; then
    echo -e "\r ===> Make sure that paper PDFs are in one-column CEURART format, see https://ceur-ws.org/Vol-XXX/"
    echo " "
  else
    echo -e "\rok                                                                          "
    echo " "
  fi
fi 



echo ""
echo "(*) Check whether the paper titles in index.html match the title of the PDF file"

MISMATCHTITLE="no"

# Capture Perl output directly - Note: index.html is expected inside TARGET_DIR
perl_output=$(perl -Mopen=locale -0777 -ne '
use strict;
use warnings;

# Get the target directory passed from the shell
my $target_dir = $ARGV[1] || ".";
my $any_mismatch = 0;

sub normalize_text {
    my ($text) = @_;
    $text =~ s/[\n\t\r]+/ /g;
    $text =~ s/\s+/ /g;
    $text =~ s/^\s+|\s+$//g;
    $text = lc($text);
    $text =~ s/[^a-z0-9\s]/ /g;
    $text =~ s/\s+/ /g;
    return $text;
}

while (/<li[^>]*>(.*?)<\/li>/sg) {
    my $li = $1;
    my $pdf_rel;
    my $title;

    if ($li =~ /<a href="([^"]+\.pdf)"/s) {
        $pdf_rel = $1;
        # CRITICAL FIX: Prepend the target directory to the relative link
        my $pdf_full = "$target_dir/$pdf_rel";

        if ($li =~ /<span class="CEURTITLE">(.*?)<\/span>/s) {
            $title = $1;
        } elsif ($li =~ /<a [^>]*class="CEURTITLE">(.*?)<\/a>/s) {
            $title = $1;
        } else {
            next;
        }
        
        $title =~ s/\s+/ /g;
        $title =~ s/ \*$//;

        # Use the full path to check for existence
        if (!-f $pdf_full) {
            print "Error: File $pdf_rel missing in $target_dir\n";
            $any_mismatch = 1;
            next;
        }

        # Use the full path for pdftotext extraction
        my $page1 = `pdftotext -q -f 1 -l 1 "$pdf_full" - 2>/dev/null`;
        
        my $normtitle = normalize_text($title);
        my $normpage  = normalize_text($page1);

        $normtitle =~ s/^\s+|\s+$//g; 
        my $escaped = quotemeta($normtitle);

        if ($normpage !~ /$escaped/) {
            print "$pdf_rel: Expected CEURTITLE \"$title\" not found on first page\n";
            $any_mismatch = 1;
        }
    }
}

if ($any_mismatch) {
    print "__MISMATCHTITLE__=yes\n";
} else {
    print "__MISMATCHTITLE__=no\n";
}
' "$TARGET_DIR/index.html" "$TARGET_DIR")
while IFS= read -r line; do
    if [[ "$line" == __MISMATCHTITLE__=* ]]; then
        MISMATCHTITLE="${line#__MISMATCHTITLE__=}"
    else
        echo "$line"
    fi
done <<< "$perl_output"


if [[ "$MISMATCHTITLE" == "yes" ]] ; then
  echo " ===> Make sure that paper CEURTITLE in index.html is matching the title in the paper PDFs!"
  echo "      Make sure that the title in the PDF file is not a bitmap."
  echo " "
else
  echo "ok"
  echo " "
fi